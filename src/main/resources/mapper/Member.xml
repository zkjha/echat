<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="com.ecard.mapper.MemberMapper">
	
	<!-- 判断会员级别名称是否存在 -->
	<select id="judgeMobileIsExist" resultType="string">
		SELECT (CASE WHEN COUNT(STRMEMBERID)>0 THEN 'true' ELSE 'false' END) FROM tb_member
		<where>
			<!-- 级别ID -->
			<if test="strMemberid != null and strMemberid != ''">	
				AND STRMEMBERID!=#{strMemberid}
			</if>
			<!-- 会员手机号-->
			<if test="strMobile != null and strMobile != ''">	
				AND STRMOBILE=#{strMobile}
			</if>
		</where>
	</select>
	
	<!-- 根据手机号查询会员信息 -->
	<select id="getMemberEntityByMobile" parameterType="string" resultType="com.ecard.entity.MemberEntity">
		SELECT STRMEMBERID AS strMemberid, STRMEMBERCARDNUM AS strMembercardnum FROM tb_member WHERE STRMOBILE=#{strMobile} LIMIT 1
	</select>
	
	<!-- 根据会员ID查询会员信息 -->
	<select id="getMemberEntityById" parameterType="string" resultType="com.ecard.entity.MemberEntity">
		SELECT STRMEMBERID AS strMemberid, STRREALNAME AS strRealname, STRIDCARD AS strIdcard, STRMOBILE AS strMobile,
		       INTAGE AS intAge, STRMEMBERCARDNUM AS strMembercardnum, STRLEVELSID AS strLevelsid, INTSEX AS intSex,
		       INTSTATUS AS intStatus, INTINTEGRAL AS intIntegral, DBALANCE AS dBalance
		FROM tb_member WHERE STRMEMBERID=#{strMemberid}
	</select>
	
	<!-- 根据会员ID查询会员登录需要的信息 -->
	<select id="getLoginUserInfoById" parameterType="string" resultType="com.ecard.entity.MemberEntity">
		SELECT TM.STRMEMBERID AS strMemberid, TM.STRMEMBERCARDNUM AS strMembercardnum, TML.STRLEVELSNAME AS strLevelsid,
		       TM.INTINTEGRAL AS intIntegral, TM.DBALANCE AS dBalance
		FROM tb_member TM, tb_member_levels TML WHERE TM.STRLEVELSID=TML.STRLEVELSID AND TM.STRMEMBERID=#{strMemberid}
	</select>
	
	<!-- 查询所有会员级别信息 -->
	<select id="listAllMemberLevels" parameterType="map" resultType="com.ecard.entity.MemberlevelsEntity">
	     SELECT STRLEVELSID AS strLevelsid, STRLEVELSNAME AS strLevelsname, INTSTATUS AS intStatus
	      FROM tb_member_levels WHERE INTSTATUS=#{intStatus} ORDER BY STRINSERTTIME DESC
	</select>
	
	<!-- 会员列表返回参数Map -->
	<resultMap id="memberVO" type="com.ecard.vo.MemberVO">
		<id property="strMemberid" column="STRMEMBERID"></id>
		<result property="strRealname" column="STRREALNAME"></result>
		<result property="strMobile" column="STRMOBILE"></result>
		<result property="strMembercardnum" column="STRMEMBERCARDNUM"></result>
		<result property="intStatus" column="INTSTATUS"></result>
		<result property="intIntegral" column="INTINTEGRAL"></result>
		<result property="dBalance" column="DBALANCE"></result>
		<result property="strLevelsname" column="STRLEVELSNAME"></result>
		<result property="strInserttime" column="STRINSERTTIME"></result>
		<association property="intVouchers" column="STRMEMBERID" select="getIntVouchersByMemberid"></association>
	</resultMap>
	
	<!-- 查询会员优惠券数量 -->
	<select id="getIntVouchersByMemberid" parameterType="string" resultType="int">
		SELECT 5
	</select>
	
	<!-- 查询会员列表 -->
	<select id="listMember" parameterType="map" resultMap="memberVO">
	     SELECT TM.STRMEMBERID, TM.STRREALNAME, TM.STRMOBILE, TM.STRMEMBERCARDNUM, TM.INTSTATUS, TM.INTINTEGRAL, TM.DBALANCE, TM.STRINSERTTIME, TML.STRLEVELSNAME
      	 FROM tb_member TM, tb_member_levels TML
	      <where>
	      	TM.STRLEVELSID=TML.STRLEVELSID
	      	<if test="strSearchkey != null and strSearchkey != ''">
	      		AND (TM.STRREALNAME LIKE CONCAT('%',#{strSearchkey},'%') 
	      		     OR TM.STRMOBILE LIKE CONCAT('%',#{strSearchkey}) 
	      		     OR TM.STRMEMBERCARDNUM LIKE CONCAT('%',#{strSearchkey})
	      		     OR TML.STRLEVELSNAME=#{strSearchkey}
	      		     ) 
	      	</if>
	      </where>
	      ORDER BY STRINSERTTIME DESC
	      LIMIT #{pageFrom}, #{pageSize}
	</select>
	
	<!-- 查询会员总数量-->
	<select id="getMemberTotalCount" parameterType="map" resultType="int">
	     SELECT COUNT(TM.STRMEMBERID)
      	 FROM tb_member TM, tb_member_levels TML
	      <where>
	      	TM.STRLEVELSID=TML.STRLEVELSID
	      	<if test="strSearchkey != null and strSearchkey != ''">
	      		AND (TM.STRREALNAME LIKE CONCAT('%',#{strSearchkey},'%') 
	      		     OR TM.STRMOBILE LIKE CONCAT('%',#{strSearchkey}) 
	      		     OR TM.STRMEMBERCARDNUM LIKE CONCAT('%',#{strSearchkey})
	      		     OR TML.STRLEVELSNAME=#{strSearchkey}
	      		     ) 
	      	</if>
	      </where>
	</select>
	
	<!-- 新增会员 -->
	<insert id="insertMember" parameterType="com.ecard.entity.MemberEntity">
		INSERT INTO tb_member (STRMEMBERID, STRREALNAME, STRIDCARD, STRMOBILE, INTAGE, STRMEMBERCARDNUM,
		                         STRLEVELSID, INTSEX, INTSTATUS, STRINSERTTIME)
								VALUES
							(#{strMemberid}, #{strRealname}, #{strIdcard}, #{strMobile}, #{intAge}, #{strMembercardnum},
	                         #{strLevelsid}, #{intSex}, #{intStatus}, #{strInserttime})
	</insert>
	
	<!-- 新增会员详细信息 -->
	<insert id="insertMemberDetail" parameterType="com.ecard.entity.MemberdetailEntity">
		INSERT INTO tb_member_detail (STRMEMBERDETAILID, STRMEMBERID, STRMODELOFCAR, STRCARLICENSE, STRCARCOLOR, STRCARTYPE,
		                         DBUYPRICE, STRBUYDATE, STRADDRESS, STRUSENATURE, STRREGISTERDATE, STRCARIDENTIFYCODE, STRDATEOFISSUE, STRENGINENUMBER,
		                         STRPOSTPROVINCE, STRPOSTCITY, STRPOSTAREA, STRPOSTSTREET, STRPOSTDETAILADDRESS, STRPOSTCODE, STRINSERTTIME)
								VALUES
								(#{strMemberdetailid}, #{strMemberid}, #{strModelofcar}, #{strCarlicense}, #{strCarcolor}, #{strCartype},
								 #{dBuyprice}, #{strBuydate}, #{strAddress}, #{strUsenature}, #{strRegisterdate}, #{strCaridentifycode}, #{strDateofissue}, #{strEnginenumber},
		                         #{strPostprovince}, #{strPostcity}, #{strPostarea}, #{strPoststreet}, #{strPostdetailaddress}, #{strPostcode}, #{strInserttime}
		                         )
	</insert>
	
	<!-- 批量插入会员拓展属性 -->
	<insert id="batchInsertMemberexpandattribute" parameterType="list">
		INSERT INTO tb_member_expand_attribute (STRATTRIBUTEID, STRMEMBERID, STRINFORMATIONID, STRATTRIBUTEVALUE, STRINSERTTIME)
								VALUES
							    <foreach collection="attributeList" item="attribute" index="index" separator=",">
						    		(#{attribute.strAttributeid}, #{attribute.strMemberid}, #{attribute.strInformationid}, #{attribute.strAttributevalue}, #{attribute.strInserttime})
							    </foreach>	
	</insert>
	
	<!-- 查询会员基本信息 -->
	<select id="getMemberById" parameterType="string" resultType="com.ecard.entity.MemberEntity">
		SELECT STRMEMBERID AS strMemberid, STRREALNAME AS strRealname, STRIDCARD AS strIdcard, STRMOBILE AS strMobile, INTAGE AS intAge, 
		       STRMEMBERCARDNUM AS strMembercardnum, STRLEVELSID AS strLevelsid, INTSEX AS intSex, INTSTATUS AS intStatus
		FROM tb_member
		WHERE STRMEMBERID=#{strMemberid}
	</select>
	
	<!-- 查询会员详细信息 -->
	<select id="getMemberdetailById" parameterType="string" resultType="com.ecard.entity.MemberdetailEntity">
		SELECT STRMEMBERDETAILID AS strMemberdetailid, STRMEMBERID AS strMemberid, STRMODELOFCAR AS strModelofcar, STRCARLICENSE AS strCarlicense, 
		       STRCARCOLOR AS strCarcolor, STRCARTYPE AS strCartype, DBUYPRICE AS dBuyprice, STRBUYDATE AS strBuydate, STRADDRESS AS strAddress, 
		       STRUSENATURE AS strUsenature, STRREGISTERDATE AS strRegisterdate, STRCARIDENTIFYCODE AS strCaridentifycode, STRDATEOFISSUE AS strDateofissue, 
		       STRENGINENUMBER AS strEnginenumber, STRPOSTPROVINCE AS strPostprovince, STRPOSTCITY AS strPostcity, STRPOSTAREA AS strPostarea, 
		       STRPOSTSTREET AS strPoststreet, STRPOSTDETAILADDRESS AS strPostdetailaddress, STRPOSTCODE AS strPostcode
		FROM tb_member_detail
		WHERE STRMEMBERID=#{strMemberid} LIMIT 1
	</select>
	
	<!-- 查询会员拓展资料信息 -->
	<select id="listMemberExpandInfoById" parameterType="string" resultType="com.ecard.entity.MemberexpandattributeEntity">
		SELECT STRATTRIBUTEID AS strAttributeid, STRMEMBERID AS strMemberid, STRINFORMATIONID AS strInformationid, STRATTRIBUTEVALUE AS strAttributevalue
		FROM tb_member_expand_attribute
		WHERE STRMEMBERID=#{strMemberid}
	</select>
	
	<!-- 修改会员基本信息 -->
	<update id="updateMember" parameterType="com.ecard.entity.MemberEntity">
		UPDATE tb_member SET STRREALNAME=#{strRealname}, STRIDCARD=#{strIdcard}, INTAGE=#{intAge}, STRLEVELSID=#{strLevelsid}, INTSEX=#{intSex}, 
		                     INTSTATUS=#{intStatus}, STRUPDATETIME=#{strUpdatetime}
		WHERE STRMEMBERID=#{strMemberid}
	</update>
	
	<!-- 修改会员详细信息 -->
	<update id="updateMemberDetail" parameterType="com.ecard.entity.MemberdetailEntity">
		UPDATE tb_member_detail SET STRMODELOFCAR=#{strModelofcar}, STRCARLICENSE=#{strCarlicense}, STRCARCOLOR=#{strCarcolor}, STRCARTYPE=#{strCartype},
		 							DBUYPRICE=#{dBuyprice}, STRBUYDATE=#{strBuydate}, STRADDRESS=#{strAddress}, STRUSENATURE=#{strUsenature}, 
		 							STRREGISTERDATE=#{strRegisterdate}, STRCARIDENTIFYCODE=#{strCaridentifycode}, STRDATEOFISSUE=#{strDateofissue}, 
		 							STRENGINENUMBER=#{strEnginenumber}, STRPOSTPROVINCE=#{strPostprovince}, STRPOSTCITY=#{strPostcity}, STRPOSTAREA=#{strPostarea}, 
		 							STRPOSTSTREET=#{strPoststreet}, STRPOSTDETAILADDRESS=#{strPostdetailaddress}, STRPOSTCODE=#{strPostcode}, STRUPDATETIME=#{strUpdatetime}
		WHERE STRMEMBERID=#{strMemberid}
	</update>
	
	<!-- 删除会员拓展资料信息 -->
	<delete id="deleteMemberexpandattribute" parameterType="string">
		DELETE FROM tb_member_expand_attribute WHERE STRMEMBERID=#{strMemberid}
	</delete>
	
	
</mapper>